<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qåœ˜é•· 12/30 åˆé¤åœ˜ ğŸŒ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å¥åº·é¤é¢¨æ ¼é…è‰² */
        body { background-color: #fdfbf7; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; color: #4b5563; }
        .mobile-container { max-width: 420px; margin: 0 auto; background: #ffffff; min-height: 100vh; position: relative; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        
        /* åº•éƒ¨å›ºå®šæ¬„ */
        .sticky-bottom { position: fixed; bottom: 0; left: 0; right: 0; max-width: 420px; margin: 0 auto; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); border-top: 1px solid #e5e7eb; padding: 16px; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 40; }
        
        /* è¼‰å…¥å‹•ç•« */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #10b981; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* è‡ªå®šç¾©æŒ‰éˆ•æ¨£å¼ */
        .btn-primary { background: #f97316; color: white; transition: all 0.2s; } 
        .btn-primary:hover { background: #ea580c; }
        .btn-outline { border: 2px solid #10b981; color: #059669; background: #ecfdf5; } 
        .btn-outline:hover { background: #d1fae5; }
        
        /* é¸é …å¡æ¨£å¼ */
        .radio-card input:checked + div { border-color: #10b981; background-color: #ecfdf5; color: #065f46; ring: 2px solid #10b981; }
        .radio-card div { transition: all 0.2s; }
        .recommend-badge { position: absolute; top: -10px; right: -5px; background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: bold; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
    </style>
</head>
<body>

<div class="mobile-container pb-36">
    <header class="bg-emerald-600 text-white p-5 sticky top-0 z-30 shadow-sm rounded-b-2xl">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-xl font-bold tracking-wide">ğŸ± 12/30 åˆé¤åœ˜</h1>
                <p class="text-emerald-100 text-sm mt-1">åƒå¾—å¥åº·ï¼Œä»˜æ¬¾è¼•é¬†</p>
            </div>
            <div class="text-right">
                <div class="text-xs text-emerald-200">12/29 16:00 æˆªå–®</div>
                <div id="timer" class="font-mono font-bold text-yellow-300 text-lg">è¨ˆç®—ä¸­...</div>
            </div>
        </div>
    </header>

    <div class="px-6 pt-6" id="instruction-card">
        <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
            <h3 class="font-bold text-gray-700 mb-2 border-l-4 border-emerald-500 pl-2">ğŸ’¡ æ“ä½œä¸‰æ­¥é©Ÿ</h3>
            <ol class="text-sm text-gray-600 space-y-2 list-decimal list-inside">
                <li>é»æ“Šä¸‹æ–¹æŒ‰éˆ•å»åº—å®¶ç¶²ç«™é»é¤ã€‚</li>
                <li>è¨˜ä¸‹æ‚¨çš„<b class="text-orange-500">ç¸½é‡‘é¡</b>ã€‚</li>
                <li>å›ä¾†é€™è£¡å¡«é‡‘é¡ï¼Œ<b class="text-emerald-600">ç›¡é‡ä»¥åŒ¯æ¬¾ç‚ºä¸»</b>ï¼Œæ–¹ä¾¿åœ˜é•·å°å¸³å–”ï¼ğŸ™</li>
            </ol>
        </div>
    </div>

    <div id="form-container">
        <div class="p-6">
            <div class="bg-orange-50 rounded-xl p-5 border border-orange-100 shadow-sm">
                <h2 class="font-bold text-gray-800 text-lg mb-2 flex items-center">
                    <span class="bg-orange-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">1</span>
                    å‰å¾€åº—å®¶é»é¤
                </h2>
                <p class="text-sm text-gray-600 mb-4 leading-relaxed">
                    è«‹å…ˆè‡³åº—å®¶é é¢æŒ‘é¸é¤é»ä¸¦é€å‡ºè¨‚å–®ã€‚
                    <br><span class="text-orange-600 font-bold">âš ï¸ è«‹å‹™å¿…è¨˜ä½æ‚¨çš„ã€Œç¸½é‡‘é¡ã€ï¼</span>
                </p>
                <a href=" https://ddc.ai/JxyYMMR" target="_blank" class="block w-full text-center btn-outline font-bold py-3 rounded-xl shadow-sm transition">
                    ğŸ¥— é–‹å•Ÿé»é¤èœå–®
                </a>
            </div>
        </div>

        <div class="px-6 pb-6 space-y-5">
            <div class="flex items-center">
                <span class="bg-emerald-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">2</span>
                <h2 class="font-bold text-gray-800 text-lg">å›å ±é‡‘é¡èˆ‡ä»˜æ¬¾</h2>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">æ‚¨å‰›å‰›é»äº†å¤šå°‘éŒ¢ï¼Ÿ <span class="text-red-400">*</span></label>
                <div class="relative rounded-md shadow-sm">
                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-4">
                        <span class="text-gray-500 font-bold">$</span>
                    </div>
                    <input type="number" id="manual-price" class="block w-full rounded-xl border-gray-200 pl-8 p-4 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-emerald-500 focus:outline-none text-2xl font-bold text-gray-800 placeholder-gray-300 transition" placeholder="0">
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">æ‚¨çš„å§“å <span class="text-red-400">*</span></label>
                    <input type="text" id="username" placeholder="è«‹èˆ‡é»é¤ç¶²ç«™å¡«å¯«ä¸€è‡´" class="block w-full rounded-lg border-gray-200 p-3 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">ä»˜æ¬¾æ–¹å¼ <span class="text-red-400">*</span></label>
                    
                    <div class="space-y-3">
                        <label class="cursor-pointer radio-card block relative">
                            <input type="radio" name="payment_method" value="transfer" class="hidden" checked>
                            <div class="border border-gray-200 rounded-lg p-3 flex items-center hover:bg-gray-50">
                                <div class="text-2xl mr-3">ğŸ“²</div>
                                <div class="text-left">
                                    <div class="text-sm font-bold text-gray-800">éŠ€è¡Œè½‰å¸³</div>
                                    <div class="text-xs text-emerald-600 font-bold">âœ¨ æ¨è–¦ï¼åœ˜é•·å¥½å°å¸³</div>
                                </div>
                            </div>
                            <div class="recommend-badge">æ¨</div>
                        </label>

                        <label class="cursor-pointer radio-card block">
                            <input type="radio" name="payment_method" value="cash" class="hidden">
                            <div class="border border-gray-200 rounded-lg p-3 flex items-center hover:bg-gray-50">
                                <div class="text-2xl mr-3">ğŸ’µ</div>
                                <div class="text-left">
                                    <div class="text-sm font-bold text-gray-800">çµ¦ç¾é‡‘</div>
                                    <div class="text-xs text-gray-400">è«‹è¦ªè‡ªäº¤çµ¦ Q åœ˜é•·</div>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="success-view" class="hidden p-6 animate-slide-up">
        </div>

    <div class="sticky-bottom" id="footer-bar">
        <button id="submit-btn" class="w-full btn-primary py-4 rounded-xl font-bold shadow-lg text-lg flex justify-center items-center">
            ç¢ºèªé‡‘é¡ï¼Œé€å‡º
        </button>
    </div>

    <div id="payment-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-40 z-50 flex items-end justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-[420px] rounded-t-3xl p-8 animate-slide-up shadow-2xl">
            <div id="payment-content"></div>
            <button onclick="document.getElementById('payment-modal').classList.add('hidden')" class="mt-6 w-full text-gray-400 text-sm hover:text-gray-600">é—œé–‰è¦–çª— (ä¿ç•™è³‡è¨Š)</button>
        </div>
    </div>
    
    <div id="admin-view" class="hidden fixed inset-0 bg-gray-50 z-50 overflow-y-auto mobile-container">
        <header class="bg-gray-800 text-white p-4 sticky top-0 flex justify-between items-center shadow-lg">
            <h1 class="font-bold flex items-center">ğŸ•µï¸ Qåœ˜é•·å¾Œå° <span class="ml-2 text-xs bg-gray-700 px-2 py-0.5 rounded text-gray-300">ç®¡ç†æ¨¡å¼</span></h1>
            <button onclick="toggleAdmin()" class="text-xs bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded transition">é—œé–‰</button>
        </header>
        <div class="p-4">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <div class="text-xs text-gray-400 uppercase tracking-wider">æ‡‰æ”¶ç¸½é¡</div>
                    <div class="text-2xl font-bold text-gray-800" id="admin-total-receivable">$0</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <div class="text-xs text-gray-400 uppercase tracking-wider">è¨‚å–®æ•¸</div>
                    <div class="text-2xl font-bold text-gray-800" id="admin-order-count">0</div>
                </div>
            </div>
            
            <h3 class="font-bold text-gray-700 mb-3 pl-1">å¸³å‹™åˆ—è¡¨</h3>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-500 font-medium">
                        <tr>
                            <th class="p-3">ç‹€æ…‹</th>
                            <th class="p-3">å§“å/é‡‘é¡</th>
                            <th class="p-3 text-right">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="admin-table-body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="fixed bottom-28 right-5 z-30">
        <button onclick="toggleAdmin()" class="bg-gray-800 text-white w-12 h-12 rounded-full shadow-xl flex items-center justify-center opacity-40 hover:opacity-100 transition-all transform hover:scale-110">
            âš™ï¸
        </button>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ğŸ”´ è«‹å¡«å…¥æ‚¨çš„ Firebase Config
    const firebaseConfig = {
  apiKey: "AIzaSyCjrm6t1v9wcOoEWzygcPgTvl41Fi1IkAM",
  authDomain: "q-lunch.firebaseapp.com",
  projectId: "q-lunch",
  storageBucket: "q-lunch.firebasestorage.app",
  messagingSenderId: "125719980050",
  appId: "1:125719980050:web:d0c5d825d22887cd1ad0cb",
  measurementId: "G-6SZ29EDZ4R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // éŠ€è¡Œè³‡è¨Š
    const bankName = "æ¸£æ‰“éŠ€è¡Œ (052)";
    const bankAccount = "08720000262256";
    const formattedAccount = "0872-0000-2622-56"; // å·²ä¿®æ­£æ ¼å¼

    // é€å–®é‚è¼¯
    const submitBtn = document.getElementById("submit-btn");
    
    submitBtn.addEventListener('click', async () => {
        const name = document.getElementById("username").value.trim();
        const priceInput = document.getElementById("manual-price").value;
        const total = parseInt(priceInput);
        const method = document.querySelector('input[name="payment_method"]:checked').value;

        if (!total || total <= 0) return alert("è«‹è¼¸å…¥é‡‘é¡");
        if (!name) return alert("è«‹è¼¸å…¥æ‚¨çš„å§“å");

        const orderData = {
            name: name,
            total: total,
            method: method, // ç´€éŒ„ä»˜æ¬¾æ–¹å¼
            status: 'pending', 
            last5: '',
            createdAt: serverTimestamp()
        };

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loader"></span> è™•ç†ä¸­...';

        try {
            const docRef = await addDoc(collection(db, "orders"), orderData);
            
            // éš±è—è¡¨å–®
            document.getElementById('form-container').classList.add('hidden');
            document.getElementById('instruction-card').classList.add('hidden');
            document.getElementById('footer-bar').classList.add('hidden');

            // æ¸²æŸ“æˆåŠŸç•«é¢
            renderSuccessView(docRef.id, total, name, method);
            
            // é¡¯ç¤ºå½ˆçª—
            showPaymentModal(docRef.id, total, name, method);

        } catch (e) {
            console.error("Error: ", e);
            alert("ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦");
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'ç¢ºèªé‡‘é¡ï¼Œé€å‡º';
        }
    });

    // æ¸²æŸ“æˆåŠŸå¾Œçš„éœæ…‹ç•«é¢
    function renderSuccessView(orderId, total, name, method) {
        const successView = document.getElementById('success-view');
        let contentHtml = '';

        if (method === 'transfer') {
            // è½‰å¸³
            contentHtml = `
                <div class="text-center mb-6">
                    <div class="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-4xl">âœ…</span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">è¨‚å–®å·²é€å‡º</h2>
                    <p class="text-gray-500 mt-2">è«‹ä¾ç…§ä¸‹æ–¹è³‡è¨Šé€²è¡Œè½‰å¸³</p>
                </div>
                <div class="bg-emerald-50 p-5 rounded-2xl border border-emerald-100 mb-6 relative shadow-sm">
                    <p class="text-xs text-emerald-600 font-bold uppercase tracking-wide mb-1">æ‡‰ä»˜é‡‘é¡</p>
                    <div class="text-3xl font-bold text-emerald-700 mb-4">$${total}</div>
                    <div class="border-t border-emerald-200 my-3"></div>
                    <p class="text-xs text-emerald-600 font-bold uppercase tracking-wide mb-1">${bankName}</p>
                    <div class="flex items-center justify-between">
                        <div class="font-mono font-bold text-lg text-gray-800 break-all">${formattedAccount}</div>
                        <button onclick="navigator.clipboard.writeText('${bankAccount}'); alert('å¸³è™Ÿå·²è¤‡è£½ï¼')" class="text-emerald-700 bg-white border border-emerald-200 hover:bg-emerald-100 px-2 py-1 rounded text-sm font-bold transition ml-2">è¤‡è£½</button>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm">
                    <label class="block text-sm font-bold text-gray-700 mb-2">å·²è½‰å¸³ï¼Ÿè«‹è¼¸å…¥å¸³è™Ÿå¾Œäº”ç¢¼ï¼š</label>
                    <div class="flex space-x-3">
                        <input type="text" id="main-last5-input" placeholder="12345" class="flex-1 bg-gray-50 border border-gray-200 rounded-lg p-3 text-center font-mono focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                        <button id="main-report-btn" class="bg-gray-800 text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-gray-700 transition">å›å ±</button>
                    </div>
                </div>
            `;
        } else {
            // ç¾é‡‘
            contentHtml = `
                <div class="text-center mb-6">
                    <div class="bg-orange-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-4xl">ğŸ’µ</span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">è¨‚å–®å·²é€å‡º</h2>
                    <p class="text-gray-500 mt-2">è«‹æº–å‚™å¥½ç¾é‡‘</p>
                </div>
                <div class="bg-orange-50 p-6 rounded-2xl border border-orange-100 mb-6 text-center shadow-sm">
                    <p class="text-sm text-orange-600 font-bold uppercase tracking-wide mb-2">æ‡‰ä»˜é‡‘é¡</p>
                    <div class="text-4xl font-bold text-orange-700 mb-4">$${total}</div>
                    <p class="text-gray-600 text-sm">è«‹è¨˜å¾—å°‡ç¾é‡‘äº¤çµ¦ <b class="text-gray-800">Q åœ˜é•·</b></p>
                </div>
                <div class="text-center text-sm text-gray-400">
                    åœ˜é•·æ”¶æ¬¾å¾Œæœƒåœ¨å¾Œå°æ¨™è¨˜ç‚ºã€Œå·²æ ¸å°ã€
                </div>
            `;
        }
        
        successView.innerHTML = contentHtml;
        successView.classList.remove('hidden');

        // å¦‚æœæ˜¯è½‰å¸³ï¼Œç¶å®šæŒ‰éˆ•
        if (method === 'transfer') {
            document.getElementById("main-report-btn").onclick = () => submitReport(orderId, 'main-last5-input');
        }
    }

    // é¡¯ç¤ºå½ˆçª—
    function showPaymentModal(orderId, total, name, method) {
        const modal = document.getElementById("payment-modal");
        const content = document.getElementById("payment-content");
        
        let modalHtml = '';
        
        if (method === 'transfer') {
            modalHtml = `
                <div class="text-center mb-6">
                    <div class="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                        <span class="text-3xl">ğŸ‰</span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">ç™»è¨˜æˆåŠŸï¼</h2>
                    <p class="text-gray-500 mt-1">å—¨ ${name}ï¼Œè«‹è½‰å¸³ <b class="text-emerald-600 text-lg">$${total}</b></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6 relative">
                    <p class="text-xs text-gray-400 font-bold uppercase tracking-wide mb-1">${bankName}</p>
                    <div class="flex items-center justify-between">
                        <div class="font-mono font-bold text-lg text-gray-800 break-all">${formattedAccount}</div>
                        <button onclick="navigator.clipboard.writeText('${bankAccount}'); alert('å¸³è™Ÿå·²è¤‡è£½ï¼')" class="text-emerald-600 bg-emerald-50 hover:bg-emerald-100 px-2 py-1 rounded-lg text-sm font-bold transition ml-1">è¤‡è£½</button>
                    </div>
                </div>
                <div class="border-t border-gray-100 pt-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">å·²è½‰å¸³ï¼Ÿè«‹è¼¸å…¥å¸³è™Ÿå¾Œäº”ç¢¼ï¼š</label>
                    <div class="flex space-x-3">
                        <input type="text" id="modal-last5-input" placeholder="12345" class="flex-1 bg-gray-50 border border-gray-200 rounded-lg p-3 text-center font-mono focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                        <button id="modal-report-btn" class="bg-gray-800 text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-gray-700 transition">å›å ±</button>
                    </div>
                </div>
            `;
        } else {
            // ç¾é‡‘
            modalHtml = `
                <div class="text-center mb-6">
                    <div class="bg-orange-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                        <span class="text-3xl">ğŸ¤</span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">ç™»è¨˜æˆåŠŸï¼</h2>
                    <p class="text-gray-500 mt-1">å—¨ ${name}ï¼Œè«‹æº–å‚™ç¾é‡‘ <b class="text-orange-600 text-lg">$${total}</b></p>
                </div>
                <div class="bg-orange-50 p-5 rounded-xl border border-orange-100 mb-4 text-center">
                    <p class="text-gray-700 font-bold">è«‹è¨˜å¾—å°‡ç¾é‡‘äº¤çµ¦ Q åœ˜é•·</p>
                    <p class="text-xs text-gray-400 mt-1">ä¸€æ‰‹äº¤éŒ¢ï¼Œä¸€æ‰‹äº¤é£¯</p>
                </div>
                <button onclick="document.getElementById('payment-modal').classList.add('hidden')" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold">æ”¶åˆ°ï¼Œæˆ‘æœƒå»ä»˜æ¬¾</button>
            `;
        }

        content.innerHTML = modalHtml;
        modal.classList.remove("hidden");

        if (method === 'transfer') {
            document.getElementById("modal-report-btn").onclick = () => submitReport(orderId, 'modal-last5-input');
        }
    }

    // å›å ±å¾Œäº”ç¢¼é‚è¼¯
    async function submitReport(orderId, inputId) {
        const last5 = document.getElementById(inputId).value;
        if(!last5) return alert("è«‹è¼¸å…¥å…§å®¹");
        
        try {
            const orderRef = doc(db, "orders", orderId);
            await updateDoc(orderRef, { last5: last5, status: 'review' });
            alert("æ”¶åˆ°ï¼æ„Ÿè¬æ‚¨çš„é…åˆ ğŸ™");
            window.location.reload(); 
        } catch (e) { alert("å›å ±å¤±æ•—"); }
    }

    // å¾Œå°ç®¡ç†é‚è¼¯
    let unsubscribeAdmin = null;
    window.toggleAdmin = () => {
        const view = document.getElementById("admin-view");
        const isHidden = view.classList.contains("hidden");
        
        if (isHidden) {
            const pwd = prompt("è«‹è¼¸å…¥åœ˜é•·å¯†ç¢¼ï¼š");
            if (pwd !== "22") { alert("å¯†ç¢¼éŒ¯èª¤ï¼"); return; }

            view.classList.remove("hidden");
            const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
            
            unsubscribeAdmin = onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById("admin-table-body");
                tbody.innerHTML = "";
                let totalReceivable = 0;
                let count = 0;

                snapshot.forEach((item) => {
                    const data = item.data();
                    const docId = item.id;
                    count++;
                    totalReceivable += data.total;

                    // åˆ¤æ–·ç‹€æ…‹
                    let statusBadge = '';
                    if(data.status === 'pending') statusBadge = '<span class="inline-block px-2 py-1 bg-red-100 text-red-600 text-xs rounded-md font-bold">æœªä»˜</span>';
                    else if(data.status === 'review') statusBadge = '<span class="inline-block px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-md font-bold animate-pulse">å¾…æŸ¥</span>';
                    else if(data.status === 'paid') statusBadge = '<span class="inline-block px-2 py-1 bg-green-100 text-green-700 text-xs rounded-md font-bold">å·²æ ¸</span>';

                    // ä»˜æ¬¾æ–¹å¼ icon
                    let methodIcon = '';
                    if (data.method === 'cash') methodIcon = 'ğŸ’µ ç¾é‡‘';
                    else methodIcon = 'ğŸ“² è½‰å¸³';

                    // ç¢ºèªæŒ‰éˆ• (ç¾é‡‘æ¨¡å¼çš„æœªä»˜å–®ä¹Ÿéœ€è¦å¯ä»¥ç›´æ¥æ ¸å°)
                    const showVerify = (data.status === 'review' || (data.method === 'cash' && data.status === 'pending'));
                    const verifyBtn = showVerify 
                        ? `<button onclick="verifyOrder('${docId}')" class="text-blue-600 font-bold text-xs underline mr-3">ç¢ºèªæ”¶æ¬¾</button>` 
                        : '';

                    // é¡¯ç¤ºè³‡è¨Š
                    let infoText = '';
                    if (data.last5) {
                        infoText = `<span class="font-mono bg-gray-100 px-1 rounded text-gray-600">æœ«5:${data.last5}</span>`;
                    }

                    const row = `
                        <tr class="group hover:bg-gray-50 transition">
                            <td class="p-3 align-top border-b border-gray-50">
                                ${statusBadge}
                                <div class="text-[10px] text-gray-400 mt-1">${methodIcon}</div>
                            </td>
                            <td class="p-3 align-top border-b border-gray-50">
                                <div class="font-bold text-gray-800">${data.name}</div>
                                <div class="flex items-center text-xs mt-1">
                                    <span class="text-gray-500 mr-2">é‡‘é¡ $${data.total}</span>
                                    ${infoText}
                                </div>
                            </td>
                            <td class="p-3 text-right align-middle border-b border-gray-50">
                                ${verifyBtn}
                                <button onclick="deleteOrder('${docId}', '${data.name}')" class="text-gray-300 hover:text-red-500 transition p-1" title="åˆªé™¤æ­¤å–®">ğŸ—‘ï¸</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                document.getElementById("admin-total-receivable").innerText = `$${totalReceivable}`;
                document.getElementById("admin-order-count").innerText = count;
            });
        } else {
            view.classList.add("hidden");
            if(unsubscribeAdmin) unsubscribeAdmin();
        }
    };

    window.verifyOrder = async (id) => {
        try { await updateDoc(doc(db, "orders", id), { status: 'paid' }); } 
        catch(e) { alert("æ›´æ–°å¤±æ•—"); }
    };

    window.deleteOrder = async (id, name) => {
        if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€çš„è¨‚å–®å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) {
            try { await deleteDoc(doc(db, "orders", id)); } 
            catch(e) { alert("åˆªé™¤å¤±æ•—"); }
        }
    };

    // å€’æ•¸è¨ˆæ™‚å™¨ (12/29 16:00)
    const deadline = new Date("2025-12-29T16:00:00").getTime();
    setInterval(() => {
        const now = new Date().getTime();
        let diff = deadline - now;
        if(diff < 0) {
            document.getElementById("timer").innerText = "å·²æˆªæ­¢";
            const btn = document.getElementById("submit-btn");
            if(btn && !btn.disabled) { // åªåœ¨æœªé€å‡ºæ™‚é–å®š
                btn.disabled = true;
                btn.innerText = "å·²æˆªå–®ï¼Œä¸‹æ¬¡è«‹æ—©";
                btn.classList.add("bg-gray-400");
                btn.classList.remove("btn-primary");
            }
        } else {
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            document.getElementById("timer").innerText = `${h}æ™‚${m.toString().padStart(2,'0')}åˆ†${s.toString().padStart(2,'0')}ç§’`;
        }
    }, 1000);

</script>

</body>
</html>